<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Dead End Traders - Character Sheet</title>
  <style>
    body { margin:0; font-family: Arial, sans-serif; background:#000; color:#0ff; }
    #container { width:100%; max-width:1200px; margin:20px auto; position: relative; }
    .tab-buttons { text-align:center; margin-bottom:20px; }
    .tab-buttons button { background:#0ff; color:#000; border:none; padding:10px 20px; margin:5px; cursor:pointer; font-weight:bold; }
    .tab-buttons button.active { background:#ff0; }
    .tab-content { display:none; position:relative; }
    .tab-content.active { display:block; }
    img.sheet { width:100%; height:auto; display:block; }
    .overlay { position:absolute; color:#0ff; font-size:16px; }
    input, textarea { background:rgba(0,0,0,0.6); color:#0ff; border:1px solid #0ff; padding:4px; box-sizing:border-box; }
    .dot { cursor:pointer; width:20px; height:20px; line-height:20px; text-align:center; font-size:18px; display:inline-block; margin:0 2px; } 
    .filled { color:#ff0; }
    .pool-sum { font-weight:bold; margin-left:10px; min-width:30px; display:inline-block; }
    .bar { width:100%; height:10px; background:#333; border:1px solid #0ff; overflow:hidden; }
    .bar-fill { height:100%; background:linear-gradient(to right, #0ff, #00f); transition:width 0.2s; }
    #avatar { position:absolute; top:50px; left:50px; width:240px; height:480px; object-fit:cover; border:none; } 
    #avatar-input { position:absolute; top:540px; left:50px; width:240px; }
    .skills-column { display:flex; flex-direction:column; gap:8px; }
    .skill-row { display:flex; align-items:center; }
    .skill-label { width:140px; text-align:right; margin-right:12px; flex-shrink:0; }
    #export-btn, #reset-btn { background:#ff0; color:#000; border:none; padding:10px 16px; cursor:pointer; margin:10px 5px 0 0; font-weight:bold; }
  </style>
</head>
<body>

<div id="container">
  <div class="tab-buttons">
    <button onclick="openTab('page1')" class="active">Page 1: Attributes</button>
    <button onclick="openTab('page2')">Page 2: Talents & Inventory</button>
    <button onclick="openTab('page3')">Page 3: Augments</button>
    <button onclick="openTab('page4')">Page 4: Biography</button>
    <button onclick="openTab('page5')">Page 5: Extra Bio</button>
  </div>

  <button id="export-btn" onclick="exportData()">Export Data</button>
  <button id="reset-btn" onclick="resetCharacter()">Start New / Reset</button>
  <input type="file" id="import-btn" accept=".json" style="display:none;" onchange="importData(event)">
  <button onclick="document.getElementById('import-btn').click()">Import Data</button>

  <div id="page1" class="tab-content active">
    <img class="sheet" src="https://raw.githubusercontent.com/Vanoth/Dead-End-Traders-character-sheets/main/CHARACTER%20SHEET%201.png" alt="Page 1">
    
    <!-- Avatar -->
    <img id="avatar" src="" alt="Character Avatar">
    <div id="avatar-input" class="overlay">
      <input type="text" data-key="avatar-url" placeholder="Avatar URL" style="width:100%; margin-bottom:5px;">
      <input type="file" accept="image/*" onchange="handleAvatarUpload(this)">
    </div>
    
    <!-- Name / Titles / Stats (same as before) -->
    <div class="overlay" style="top:540px; left:50px; width:240px;">
      <input type="text" data-key="name" placeholder="Name" style="width:100%;">
    </div>
    <div class="overlay" style="top:570px; left:50px; width:240px;">
      <input type="text" data-key="titles" placeholder="Titles" style="width:100%;">
    </div>
    <div class="overlay" style="top:600px; left:50px; width:120px;">
      <input type="number" data-key="lv" placeholder="LV" style="width:100%;">
    </div>
    <div class="overlay" style="top:630px; left:50px; width:240px;">
      <div class="bar"><div class="bar-fill" id="health-fill" style="width:50%;"></div></div>
      <input type="range" data-key="health" min="0" max="100" value="50" style="width:100%; margin-top:4px;" oninput="updateBar(this, 'health-fill')">
    </div>
    <!-- ... rest of page 1 inputs (EXP, FAME, Kills, FatePoint, attributes, talents) remain the same ... -->
  </div>

  <div id="page2" class="tab-content">
    <img class="sheet" src="https://raw.githubusercontent.com/Vanoth/Dead-End-Traders-character-sheets/main/CHARACTER%20SHEET%20inventory2.png" alt="Page 2">

    <!-- Left column skills (adjust top values / gap if needed to pixel-match) -->
    <div class="overlay skills-column" style="top:60px; left:50px; width:480px;">
      <div class="skill-row"><span class="skill-label">Alertness</span><span class="dot" data-key="alert1" onclick="toggleDot(this)">○</span><span class="dot" data-key="alert2" onclick="toggleDot(this)">○</span><span class="dot" data-key="alert3" onclick="toggleDot(this)">○</span><span class="dot" data-key="alert4" onclick="toggleDot(this)">○</span><span class="dot" data-key="alert5" onclick="toggleDot(this)">○</span><span class="pool-sum" id="alert-sum">0</span></div>
      <div class="skill-row"><span class="skill-label">Art</span><span class="dot" data-key="art1" onclick="toggleDot(this)">○</span><span class="dot" data-key="art2" onclick="toggleDot(this)">○</span><span class="dot" data-key="art3" onclick="toggleDot(this)">○</span><span class="dot" data-key="art4" onclick="toggleDot(this)">○</span><span class="dot" data-key="art5" onclick="toggleDot(this)">○</span><span class="pool-sum" id="art-sum">0</span></div>
      <div class="skill-row"><span class="skill-label">Athletics</span><span class="dot" data-key="ath1" onclick="toggleDot(this)">○</span><span class="dot" data-key="ath2" onclick="toggleDot(this)">○</span><span class="dot" data-key="ath3" onclick="toggleDot(this)">○</span><span class="dot" data-key="ath4" onclick="toggleDot(this)">○</span><span class="dot" data-key="ath5" onclick="toggleDot(this)">○</span><span class="pool-sum" id="ath-sum">0</span></div>
      <div class="skill-row"><span class="skill-label">Brawl</span><span class="dot" data-key="brawl1" onclick="toggleDot(this)">○</span><span class="dot" data-key="brawl2" onclick="toggleDot(this)">○</span><span class="dot" data-key="brawl3" onclick="toggleDot(this)">○</span><span class="dot" data-key="brawl4" onclick="toggleDot(this)">○</span><span class="dot" data-key="brawl5" onclick="toggleDot(this)">○</span><span class="pool-sum" id="brawl-sum">0</span></div>
      <div class="skill-row"><span class="skill-label">Drive</span><span class="dot" data-key="drive1" onclick="toggleDot(this)">○</span><span class="dot" data-key="drive2" onclick="toggleDot(this)">○</span><span class="dot" data-key="drive3" onclick="toggleDot(this)">○</span><span class="dot" data-key="drive4" onclick="toggleDot(this)">○</span><span class="dot" data-key="drive5" onclick="toggleDot(this)">○</span><span class="pool-sum" id="drive-sum">0</span></div>
      <!-- Add more left-column skills here following the same pattern -->
    </div>

    <!-- Right column skills -->
    <div class="overlay skills-column" style="top:60px; left:660px; width:480px;">
      <div class="skill-row"><span class="skill-label">Animal Ken</span><span class="dot" data-key="animken1" onclick="toggleDot(this)">○</span><span class="dot" data-key="animken2" onclick="toggleDot(this)">○</span><span class="dot" data-key="animken3" onclick="toggleDot(this)">○</span><span class="dot" data-key="animken4" onclick="toggleDot(this)">○</span><span class="dot" data-key="animken5" onclick="toggleDot(this)">○</span><span class="pool-sum" id="animken-sum">0</span></div>
      <div class="skill-row"><span class="skill-label">Empathy</span><span class="dot" data-key="empathy1" onclick="toggleDot(this)">○</span><span class="dot" data-key="empathy2" onclick="toggleDot(this)">○</span><span class="dot" data-key="empathy3" onclick="toggleDot(this)">○</span><span class="dot" data-key="empathy4" onclick="toggleDot(this)">○</span><span class="dot" data-key="empathy5" onclick="toggleDot(this)">○</span><span class="pool-sum" id="empathy-sum">0</span></div>
      <div class="skill-row"><span class="skill-label">Firearms</span><span class="dot" data-key="firearms1" onclick="toggleDot(this)">○</span><span class="dot" data-key="firearms2" onclick="toggleDot(this)">○</span><span class="dot" data-key="firearms3" onclick="toggleDot(this)">○</span><span class="dot" data-key="firearms4" onclick="toggleDot(this)">○</span><span class="dot" data-key="firearms5" onclick="toggleDot(this)">○</span><span class="pool-sum" id="firearms-sum">0</span></div>
      <!-- Add remaining right-column skills here -->
    </div>

    <!-- Inventory -->
    <div class="overlay" style="top:600px; left:50px; width:1100px; height:240px;">
      <textarea data-key="inventory" placeholder="Player Inventory..." style="width:100%; height:100%;"></textarea>
    </div>
  </div>

  <div id="page3" class="tab-content">
    <img class="sheet" src="https://raw.githubusercontent.com/Vanoth/Dead-End-Traders-character-sheets/main/CHARACTER%20SHEET%203.png" alt="Page 3: Augments">
    <!-- Add your augments inputs / textareas here with pixel-perfect top/left values -->
    <!-- Example placeholder: -->
    <div class="overlay" style="top:80px; left:50px; width:1100px; height:500px;">
      <textarea data-key="augments" placeholder="Augments, cyberware, implants..." style="width:100%; height:100%;"></textarea>
    </div>
  </div>

  <div id="page4" class="tab-content">
    <img class="sheet" src="https://raw.githubusercontent.com/Vanoth/Dead-End-Traders-character-sheets/main/CHARACTER%20SHEET%204.png" alt="Page 4: Biography">
    <!-- Biography fields -->
    <div class="overlay" style="top:80px; left:50px; width:1100px; height:500px;">
      <textarea data-key="biography" placeholder="Character biography, backstory..." style="width:100%; height:100%;"></textarea>
    </div>
  </div>

  <div id="page5" class="tab-content">
    <img class="sheet" src="https://raw.githubusercontent.com/Vanoth/Dead-End-Traders-character-sheets/main/CHARACTER%20SHEET%205.png" alt="Page 5: Extra Bio">
    <!-- Extra bio / notes / appearance / contacts etc. -->
    <div class="overlay" style="top:80px; left:50px; width:1100px; height:500px;">
      <textarea data-key="extrabio" placeholder="Appearance, contacts, notes, additional lore..." style="width:100%; height:100%;"></textarea>
    </div>
  </div>

</div>

<script>
// Your existing playerKey / storage logic
let playerKey = localStorage.getItem('playerName') || prompt('Enter your player name (used for saving):') || 'default';
localStorage.setItem('playerName', playerKey);
function getStorageKey(key) { return `${playerKey}_${key}`; }

// Reset / Start New
function resetCharacter() {
  if (!confirm("This will erase ALL saved data for this character. Start fresh?")) return;
  Object.keys(localStorage).forEach(k => {
    if (k.startsWith(playerKey + '_')) localStorage.removeItem(k);
  });
  location.reload();
}

// Tab switching (fixed: use currentTarget instead of event.target)
function openTab(tabId) {
  document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
  document.querySelectorAll('.tab-buttons button').forEach(el => el.classList.remove('active'));
  document.getElementById(tabId).classList.add('active');
  document.querySelector(`button[onclick="openTab('${tabId}')"]`).classList.add('active');
}

// Toggle dot + save + update sum
function toggleDot(el) {
  const isFilled = el.textContent === '○';
  el.textContent = isFilled ? '●' : '○';
  el.classList.toggle('filled', isFilled);
  saveData(el);
  updateSum(el.closest('.skill-row'));
}

function updateSum(section) {
  const sumEl = section?.querySelector('.pool-sum');
  if (sumEl) {
    sumEl.textContent = section.querySelectorAll('.filled').length;
  }
}

// Bar
function updateBar(input, fillId) {
  document.getElementById(fillId).style.width = `${input.value}%`;
  saveData(input);
}

// Avatar upload
function handleAvatarUpload(input) {
  const file = input.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = e => {
    document.getElementById('avatar').src = e.target.result;
    localStorage.setItem(getStorageKey('avatar-data'), e.target.result);
  };
  reader.readAsDataURL(file);
}

// Save
function saveData(el) {
  const key = getStorageKey(el.dataset.key);
  const value = (el.tagName === 'INPUT' || el.tagName === 'TEXTAREA') ? el.value : el.textContent;
  localStorage.setItem(key, value);
}

// Load on start
window.addEventListener('load', () => {
  // Inputs & textareas
  document.querySelectorAll('input[data-key], textarea[data-key]').forEach(el => {
    const val = localStorage.getItem(getStorageKey(el.dataset.key)) || '';
    el.value = val;
    if (el.type === 'range') updateBar(el, `${el.dataset.key}-fill`);
    el.addEventListener('input', () => saveData(el));
  });

  // Dots
  document.querySelectorAll('.dot').forEach(el => {
    const saved = localStorage.getItem(getStorageKey(el.dataset.key));
    if (saved) {
      el.textContent = saved;
      if (saved === '●') el.classList.add('filled');
    }
    updateSum(el.closest('.skill-row'));
  });

  // Avatar
  const avatarData = localStorage.getItem(getStorageKey('avatar-data'));
  const avatarUrl  = localStorage.getItem(getStorageKey('avatar-url'));
  document.getElementById('avatar').src = avatarData || avatarUrl || '';

  document.querySelector('[data-key="avatar-url"]').addEventListener('input', e => {
    document.getElementById('avatar').src = e.target.value;
    saveData(e.target);
  });
});

// Auto-save every 5s
setInterval(() => {
  document.querySelectorAll('[data-key]').forEach(saveData);
}, 5000);

// Export / Import (unchanged but included for completeness)
function exportData() {
  const data = {};
  document.querySelectorAll('[data-key]').forEach(el => {
    data[el.dataset.key] = el.value || el.textContent;
  });
  // Also include avatar data if present
  data['avatar-data'] = localStorage.getItem(getStorageKey('avatar-data')) || '';
  const blob = new Blob([JSON.stringify(data, null, 2)], {type: 'application/json'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = `det-character-${playerKey}.json`;
  a.click();
  URL.revokeObjectURL(url);
}

function importData(event) {
  const file = event.target.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = e => {
    try {
      const data = JSON.parse(e.target.result);
      Object.keys(data).forEach(key => {
        const el = document.querySelector(`[data-key="${key}"]`);
        if (el) {
          if (el.tagName === 'INPUT' || el.tagName === 'TEXTAREA') {
            el.value = data[key];
          } else if (el.classList.contains('dot')) {
            el.textContent = data[key];
            el.classList.toggle('filled', data[key] === '●');
          }
        }
        if (key === 'avatar-data' || key === 'avatar-url') {
          document.getElementById('avatar').src = data[key];
        }
      });
      document.querySelectorAll('.skill-row').forEach(updateSum);
      // Trigger saves
      document.querySelectorAll('[data-key]').forEach(saveData);
    } catch (err) {
      alert("Invalid JSON file");
    }
  };
  reader.readAsText(file);
}
</script>

</body>
</html>
